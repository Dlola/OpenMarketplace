##  Settlements

### Introduction

---

When a customer makes a payment for an order, the entire amount is meant to be transfered to administrator's account. 
Each order carries a commission, and vendors can initiate the withdrawal of their earnings through the settlement process. 
This approach ensures a controlled and transparent financial ecosystem, providing administrators and vendors with flexibility over their financial transactions.

`OpenMarketplace` does not automatically transfer funds from the administrator to vendor accounts.
However, it is possible to integrate it with other payment gateways and automate the process of transferring funds to the vendor's account .

### Settlement frequency

---

Administrator can assign different settlement frequencies to vendors.
Settlements are being generated based on assigned frequency and contains information about period which settlement covers.
For example, if the settlement frequency is set to `weekly`, the settlement will be generated every week and will contain information about the previous week.
Factor of inclusion to certain period is defined by `paidAt` property of `Order` entity.

Settlements might be generated for the following frequencies:
- `weekly` - settlements are generated every week,
- `monthly` - settlements are generated every month,
- `quarterly` - settlements are generated every quarter,

To generate settlements use `/docker/cron/crontab` file, make sure it contains line :
``` bash
0 9 * * 1 php /srv/sylius/bin/console bitbag:settlement:generate
```

#### Settlement frequency categories

All settlement frequencies mentioned above are `cyclical` - they are generated by cron job.
However, there is one more `non-cyclical` settlement frequency- `virtual_wallet`.
This category is not cyclical and settlements are generated by vendor.

### States

---

Settlements have 3 available states, which are managed by state machine:
- `new` - the settlement is generated and not yet accepted by the seller,
- `accepted` - the settlement is accepted by the seller but not yet marked as paid,
- `paid` - the settlement is paid,

### Transitions

---

The state machine has 2 transitions:
- `accept` - moves the settlement from `new` to `accepted` when settlement for given period is accepted by the seller,
- `pay` - moves the settlement from `accepted` to `paid` when the settlement is paid,

### Payment gateway integration

---

Out-of-the-box state machine applies `pay` transition during `accept` callback in `SettlementCallbacks`.

```php
final class SettlementCallbacks implements SettlementCallbacksInterface
{
    public function __construct(
        private SettlementStateMachineTransitionInterface $settlementStateMachineTransition,
        private EntityManagerInterface $entityManager,
    ) {
    }

    public function payout(SettlementInterface $settlement): void
    {
        $this->settlementStateMachineTransition->applyIfCan(
            $settlement,
            SettlementTransitions::SETTLE,
        );

        $this->entityManager->flush();
    }
}
```

If you want to integrate OpenMarketplace with payment gateway, you have to override method `SettlementCallbacks:payout` and apply `pay` transition separately after payment is completed. 
